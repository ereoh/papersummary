# .github/workflows/release.yml

name: 'Build & Release Windows EXE'

# This workflow runs only when you push a new tag in the format v*.*.*
# on:
#   push:
#     tags:
#       - 'v*.*.*'
on:
  push:
    branches:
      - main

# A single job that builds and releases the .exe
jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      # 1. Check out your code
      - name: Check out code
        uses: actions/checkout@v4

      # 2. Set up Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          architecture: 'x64'
          
      # 3. Install your project's dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install .

      # 4. Build the .exe with Nuitka
      - name: Build with Nuitka
        uses: Nuitka/Nuitka-Action@main
        with:
          nuitka-version: main
          script-name: papersummary/gui.py
          mode: standalone
          enable-plugins: pyside6
          include-data-dir: |
            papersummary/fonts=fonts
          output-file: papersummary 

      # 5. Package the .exe into a .zip file
      - name: Package as .zip
        shell: pwsh
        run: |
          $appName = "papersummary"
          $tag = $env:GITHUB_REF_NAME
          $zipName = "${appName}-${tag}-Windows.zip"
          
          # --- THIS IS THE FIX ---
          # Point to the correct path where Nuitka built the .exe
          Compress-Archive -Path "build\gui.dist\${appName}.exe" -DestinationPath $zipName
          
          echo "ZIP_NAME=$zipName" >> $env:GITHUB_ENV

      # 6. Create the GitHub Release and upload the .zip
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ env.ZIP_NAME }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}